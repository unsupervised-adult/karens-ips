<div class="ml-detector-container">

  <!-- Behavioral Analysis Engine -->
  <div class="row mb-3">
    <div class="col-12">
      <h4 class="text-primary">
        <i class="bi bi-shield-check"></i> Behavioral Analysis Engine
        <small class="text-muted" style="font-size: 0.7em; font-weight: normal;" title="ML-based behavioral analysis from network flow evidence">‚ìò</small>
      </h4>
    </div>
  </div>
  <div class="row mb-4 g-3">
    <div class="col-md-3">
      <div class="card h-100 border-primary">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Flows Analyzed</h3>
          <div class="text-primary stat-value" id="stat_total_analyzed">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 border-primary">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Suspicious Flows</h3>
          <div class="text-danger stat-value" id="stat_ads_detected">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 border-primary">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Legitimate Flows</h3>
          <div class="text-success stat-value" id="stat_legitimate">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 border-primary">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Model Accuracy</h3>
          <div class="text-info stat-value" id="stat_accuracy">0%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Protocol Analysis & Filtering -->
  <div class="row mb-3">
    <div class="col-12">
      <h4 class="text-primary">
        <i class="bi bi-broadcast"></i> Protocol Analysis & Filtering
        <small class="text-muted" style="font-size: 0.7em; font-weight: normal; cursor: help;" title="Real-time protocol inspection for syndication networks and telemetry">‚ìò</small>
      </h4>
    </div>
  </div>
  <div class="row mb-4 g-3">
    <div class="col-md-3">
      <div class="card h-100 border-primary">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Streams Analyzed</h3>
          <div class="text-primary stat-value" id="stream_total_analyzed">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100 border-primary">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Syndication Filtered</h3>
          <div class="text-danger stat-value" id="stream_ads_detected">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100 border-primary">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Endpoints Filtered</h3>
          <div class="text-primary stat-value" id="stream_ips_blocked">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100 border-info">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Flow Drops</h3>
          <div class="text-warning stat-value" id="stream_flows_dropped">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 border-warning">
        <div class="card-body text-center p-4">
          <h3 class="text-muted text-uppercase mb-3 stat-label">Status</h3>
          <div class="text-success stat-value" id="stream_status" style="font-size: 1.5rem;">Unknown</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detection Settings -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Detection Thresholds</h5>
          <button class="btn btn-sm btn-primary" id="save_thresholds">Save Changes</button>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label for="youtube_threshold" class="form-label">Video Ad Flow Blocking</label>
              <div class="input-group">
                <input type="range" class="form-range" id="youtube_threshold" min="0.40" max="0.95" step="0.05" value="0.60">
                <span class="ms-3 fw-bold" id="youtube_threshold_value">0.60</span>
              </div>
              <small class="text-muted">Confidence threshold for blocking video ad streams (YouTube, Twitch, etc)</small>
            </div>
            <div class="col-md-3">
              <label for="cdn_threshold" class="form-label">Generic CDN Blocking</label>
              <div class="input-group">
                <input type="range" class="form-range" id="cdn_threshold" min="0.50" max="0.95" step="0.05" value="0.85">
                <span class="ms-3 fw-bold" id="cdn_threshold_value">0.85</span>
              </div>
              <small class="text-muted">Confidence threshold for non-video CDN ad blocking (higher = safer)</small>
            </div>
            <div class="col-md-3">
              <label for="control_plane_threshold" class="form-label">Ad Control Plane</label>
              <div class="input-group">
                <input type="range" class="form-range" id="control_plane_threshold" min="0.50" max="0.90" step="0.05" value="0.70">
                <span class="ms-3 fw-bold" id="control_plane_threshold_value">0.70</span>
              </div>
              <small class="text-muted">IP blocking for ad auction endpoints (prevents ads from loading)</small>
            </div>
            <div class="col-md-3">
              <label for="llm_min_threshold" class="form-label">LLM Min Confidence</label>
              <div class="input-group">
                <input type="range" class="form-range" id="llm_min_threshold" min="0.20" max="0.60" step="0.05" value="0.30">
                <span class="ms-3 fw-bold" id="llm_min_threshold_value">0.30</span>
              </div>
              <small class="text-muted">Lower bound for LLM analysis (lower = more training data)</small>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-3">
              <label for="llm_max_threshold" class="form-label">LLM Max Confidence</label>
              <div class="input-group">
                <input type="range" class="form-range" id="llm_max_threshold" min="0.70" max="0.95" step="0.05" value="0.90">
                <span class="ms-3 fw-bold" id="llm_max_threshold_value">0.90</span>
              </div>
              <small class="text-muted">Upper bound for LLM analysis (higher = more training data)</small>
            </div>
            <div class="col-md-9">
              <div class="alert alert-info mb-0 mt-4">
                <strong>LLM Range:</strong> Flows with confidence between min and max will be analyzed by LLM for labeling. 
                Current range: <strong><span id="llm_range_display">0.30 - 0.90</span></strong>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <div class="alert alert-info mb-0">
              <strong>Note:</strong> Lower thresholds increase detection rate but may cause false positives. Higher thresholds are more conservative.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detection History -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Detection History</h5>
          <div>
            <div class="form-check form-switch d-inline-block me-3">
              <input class="form-check-input" type="checkbox" id="logging_enabled" checked>
              <label class="form-check-label" for="logging_enabled">Enable Logging</label>
            </div>
            <button class="btn btn-sm btn-warning" id="clear_history">Clear History</button>
            <button class="btn btn-sm btn-primary" id="refresh_history">Refresh</button>
          </div>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="platform_filter" class="form-label">Filter by Platform:</label>
            <select class="form-select form-select-sm" id="platform_filter" style="width: 200px; display: inline-block;">
              <option value="">All Platforms</option>
              <option value="youtube">YouTube</option>
              <option value="twitch">Twitch</option>
              <option value="vimeo">Vimeo</option>
              <option value="dailymotion">Dailymotion</option>
              <option value="roku">Roku</option>
              <option value="pluto">Pluto TV</option>
            </select>
            <span class="ms-3 text-muted" id="history_total">Total: 0 detections</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Platform</th>
                  <th>Domain</th>
                  <th>Confidence</th>
                  <th>Method</th>
                  <th>Duration</th>
                  <th>Bytes</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="history_table_body">
                <tr><td colspan="8" class="text-center">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <nav>
            <ul class="pagination pagination-sm justify-content-center" id="history_pagination">
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5>Detection Timeline</h5>
        </div>
        <div class="card-body">
          <canvas id="timeline_chart" height="250"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5>Feature Importance</h5>
        </div>
        <div class="card-body">
          <canvas id="feature_importance_chart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Model Information -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">
          <h5>Model Architecture & Performance</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-primary">Core Configuration</h6>
              <table class="table table-sm table-borderless">
                <tbody>
                  <tr>
                    <th width="180">Model Type:</th>
                    <td id="model_type">-</td>
                  </tr>
                  <tr>
                    <th>Version:</th>
                    <td id="model_version">-</td>
                  </tr>
                  <tr>
                    <th>Algorithm:</th>
                    <td id="model_algorithm">-</td>
                  </tr>
                  <tr>
                    <th>Architecture:</th>
                    <td id="model_architecture">-</td>
                  </tr>
                  <tr>
                    <th>Confidence Threshold:</th>
                    <td id="model_threshold">-</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="col-md-6">
              <h6 class="text-primary">Performance Metrics</h6>
              <table class="table table-sm table-borderless">
                <tbody>
                  <tr>
                    <th width="180">Training Accuracy:</th>
                    <td id="model_training_accuracy">-</td>
                  </tr>
                  <tr>
                    <th>Validation Accuracy:</th>
                    <td id="model_validation_accuracy">-</td>
                  </tr>
                  <tr>
                    <th>False Positive Rate:</th>
                    <td id="model_fpr">-</td>
                  </tr>
                  <tr>
                    <th>Last Trained:</th>
                    <td id="model_last_trained">-</td>
                  </tr>
                  <tr>
                    <th>Training Dataset:</th>
                    <td id="model_training_dataset">-</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <h6 class="text-primary">Detection Methods</h6>
              <ul id="model_detection_methods" class="list-unstyled">
                <li>-</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6 class="text-primary">Feature Extraction Details</h6>
              <table class="table table-sm table-borderless">
                <tbody>
                  <tr>
                    <th width="180">Extraction Method:</th>
                    <td id="model_feature_extraction">-</td>
                  </tr>
                  <tr>
                    <th>Detection Window:</th>
                    <td id="model_detection_window">-</td>
                  </tr>
                  <tr>
                    <th>Update Frequency:</th>
                    <td id="model_update_frequency">-</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <h6 class="text-primary">Features Used (8 categories)</h6>
              <ul id="model_features_list" class="list-group list-group-flush">
                <li class="list-group-item">-</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs for Different Views -->
  <div class="row">
    <div class="col-12">
      <ul class="nav nav-tabs" id="mlDetectorTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="detections-tab" data-bs-toggle="tab"
                  data-bs-target="#detections" type="button" role="tab">
            Recent Detections
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="alerts-tab" data-bs-toggle="tab"
                  data-bs-target="#ml-alerts" type="button" role="tab">
            Alerts & Actions
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="settings-tab" data-bs-toggle="tab"
                  data-bs-target="#settings" type="button" role="tab">
            <i class="bi bi-gear"></i> Settings
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="dataset-tab" data-bs-toggle="tab"
                  data-bs-target="#dataset-management" type="button" role="tab">
            <i class="bi bi-database"></i> Training Dataset
          </button>
        </li>
      </ul>

      <div class="tab-content" id="mlDetectorTabContent">
        <!-- Recent Detections Tab -->
        <div class="tab-pane fade show active" id="detections" role="tabpanel">
          <div class="card mt-3">
            <div class="card-body">
              <table id="table_detections" class="table table-striped table-hover display nowrap">
                <thead>
                  <tr>
                    <th>Timestamp</th>
                    <th>Source</th>
                    <th>Source IP</th>
                    <th>Destination IP</th>
                    <th>Destination Port</th>
                    <th>Protocol</th>
                    <th>Classification</th>
                    <th>Confidence</th>
                    <th>Bytes</th>
                    <th>Packets</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Alerts & Actions Tab -->
        <div class="tab-pane fade" id="ml-alerts" role="tabpanel">

          <!-- Live Blocking Control -->
          <div class="row mb-4 mt-3">
            <div class="col-12">
              <div class="card border-secondary">
                <div class="card-header bg-light text-dark">
                  <h6 class="mb-0">Live Blocking Control</h6>
                </div>
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-md-8">
                      <h6>Automatic Blocking Status</h6>
                      <p class="text-muted small mb-0">When enabled, detected threats will be automatically blocked at the firewall level</p>
                    </div>
                    <div class="col-md-4 text-end">
                      <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input large-toggle" type="checkbox" id="live_blocking_toggle">
                        <label class="form-check-label ms-2" id="blocking_status" for="live_blocking_toggle">
                          <span class="badge bg-secondary">Checking...</span>
                        </label>
                      </div>
                    </div>
                  </div>
                  <div id="blocking_status_message" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Alerts -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card border-secondary">
                <div class="card-header bg-light text-dark">
                  <h6 class="mb-0">üö® Recent Alerts</h6>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table id="table_alerts" class="table table-sm table-hover display nowrap full-width">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>Type</th>
                          <th>Severity</th>
                          <th>Source IP</th>
                          <th>Description</th>
                          <th>Confidence</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Detection Feedback -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card border-secondary">
                <div class="card-header bg-light text-dark">
                  <h6 class="mb-0">Detection Feedback & Model Training</h6>
                </div>
                <div class="card-body">
                  <p class="text-muted">Provide feedback on recent detections to improve model accuracy</p>
                  <div class="table-responsive">
                    <table id="feedback_table" class="table table-sm table-hover">
                      <thead>
                        <tr>
                          <th>Timestamp</th>
                          <th>Source IP</th>
                          <th>Classification</th>
                          <th>Confidence</th>
                          <th>Feedback</th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Exception Management -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card border-secondary">
                <div class="card-header bg-light text-dark">
                  <h6 class="mb-0">Whitelist (IPs & URLs)</h6>
                </div>
                <div class="card-body">
                  <p class="text-muted small">Trusted IPs and URLs that will never be blocked</p>
                  <div class="mb-2">
                    <label for="whitelist_ip" class="form-label small">IP Address:</label>
                    <input type="text" class="form-control form-control-sm" id="whitelist_ip" placeholder="e.g., 192.168.1.1">
                  </div>
                  <div class="mb-3">
                    <label for="whitelist_url" class="form-label small">URL/Domain:</label>
                    <input type="text" class="form-control form-control-sm" id="whitelist_url" placeholder="e.g., example.com">
                  </div>
                  <button class="btn btn-success w-100 mb-3" id="btn_add_whitelist">Add to Whitelist</button>
                  <div class="list-group" id="whitelist_items">
                    <div class="text-muted small">No whitelisted IPs or URLs</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-secondary">
                <div class="card-header bg-light text-dark">
                  <h6 class="mb-0">Blacklist (IPs & URLs)</h6>
                </div>
                <div class="card-body">
                  <p class="text-muted small">Manually blocked IPs and URLs</p>
                  <div class="mb-2">
                    <label for="blacklist_ip" class="form-label small">IP Address:</label>
                    <input type="text" class="form-control form-control-sm" id="blacklist_ip" placeholder="e.g., 10.0.0.1">
                  </div>
                  <div class="mb-3">
                    <label for="blacklist_url" class="form-label small">URL/Domain:</label>
                    <input type="text" class="form-control form-control-sm" id="blacklist_url" placeholder="e.g., ads.example.com">
                  </div>
                  <button class="btn btn-danger w-100 mb-3" id="btn_add_blacklist">Add to Blacklist</button>
                  <div class="list-group" id="blacklist_items">
                    <div class="text-muted small">No blocked IPs or URLs</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Manual Actions -->
          <div class="row">
            <div class="col-12">
              <div class="card border-secondary">
                <div class="card-header bg-light text-dark">
                  <h6 class="mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <button class="btn btn-outline-primary w-100 mb-2" id="btn_clear_blocks">
                        Clear All Blocks
                      </button>
                      <small class="text-muted">Remove all firewall rules</small>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-outline-warning w-100 mb-2" id="btn_retrain_model">
                        Retrain Model Now
                      </button>
                      <small class="text-muted">Force immediate retraining</small>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-outline-info w-100 mb-2" id="btn_export_detections">
                        Export Detections
                      </button>
                      <small class="text-muted">Download as CSV</small>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-outline-secondary w-100 mb-2" id="btn_view_logs">
                        View System Logs
                      </button>
                      <small class="text-muted">Show recent activity</small>
                    </div>
                  </div>
                  <div id="action_status" class="mt-3"></div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
          <div class="card mt-3">
            <div class="card-header bg-primary text-white">
              <h5><i class="bi bi-gear"></i> Detection Settings</h5>
              <p class="mb-0 small">Adjust detection thresholds and model parameters</p>
            </div>
            <div class="card-body">
              
              <!-- Save/Reset Buttons -->
              <div class="row mb-3">
                <div class="col-12">
                  <button id="btn_save_config" class="btn btn-success me-2">
                    <i class="bi bi-check-circle"></i> Save Configuration
                  </button>
                  <button id="btn_reset_config" class="btn btn-warning me-2">
                    <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                  </button>
                  <button id="btn_restart_service" class="btn btn-info">
                    <i class="bi bi-arrow-repeat"></i> Restart Monitor Service
                  </button>
                  <div id="config_status" class="mt-2"></div>
                </div>
              </div>

              <!-- Duration Thresholds -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">Duration Thresholds (seconds)</h6>
                </div>
                <div class="col-md-4">
                  <label for="streaming_min_duration" class="form-label">
                    Content Minimum Duration
                    <small class="text-muted">(videos shorter than this ignored)</small>
                  </label>
                  <input type="number" class="form-control" id="streaming_min_duration" min="10" max="600" step="10">
                </div>
                <div class="col-md-4">
                  <label for="ad_duration_min" class="form-label">
                    Ad Minimum Duration
                    <small class="text-muted">(flows shorter ignored)</small>
                  </label>
                  <input type="number" class="form-control" id="ad_duration_min" min="1" max="30" step="1">
                </div>
                <div class="col-md-4">
                  <label for="ad_duration_max" class="form-label">
                    Ad Maximum Duration
                    <small class="text-muted">(ads longer = false positive)</small>
                  </label>
                  <input type="number" class="form-control" id="ad_duration_max" min="10" max="300" step="10">
                </div>
              </div>

              <!-- Size Thresholds -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">Size Thresholds (bytes)</h6>
                </div>
                <div class="col-md-4">
                  <label for="streaming_min_bytes" class="form-label">
                    Content Minimum Bytes
                  </label>
                  <input type="number" class="form-control" id="streaming_min_bytes" min="1000" max="100000" step="1000">
                </div>
                <div class="col-md-4">
                  <label for="streaming_min_packets" class="form-label">
                    Content Minimum Packets
                  </label>
                  <input type="number" class="form-control" id="streaming_min_packets" min="10" max="200" step="10">
                </div>
                <div class="col-md-4">
                  <label for="ad_min_bytes" class="form-label">
                    Ad Minimum Bytes
                  </label>
                  <input type="number" class="form-control" id="ad_min_bytes" min="1000" max="50000" step="1000">
                </div>
              </div>

              <!-- Detection Sensitivity -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">Detection Sensitivity</h6>
                </div>
                <div class="col-md-6">
                  <label for="duration_ratio_threshold" class="form-label">
                    Duration Ratio Threshold
                    <small class="text-muted">(ad must be &lt; X% of content)</small>
                  </label>
                  <input type="range" class="form-range" id="duration_ratio_threshold" min="0.1" max="0.5" step="0.05">
                  <div class="text-center" id="duration_ratio_value">30%</div>
                </div>
                <div class="col-md-6">
                  <label for="confidence_threshold" class="form-label">
                    Confidence Threshold
                    <small class="text-muted">(minimum to report)</small>
                  </label>
                  <input type="range" class="form-range" id="confidence_threshold" min="0.5" max="0.95" step="0.05">
                  <div class="text-center" id="confidence_value">75%</div>
                </div>
              </div>

              <!-- Protocol Settings -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">üîê Protocol & Analysis</h6>
                </div>
                <div class="col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable_quic_detection">
                    <label class="form-check-label" for="enable_quic_detection">
                      QUIC Detection
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enable_encrypted_analysis">
                    <label class="form-check-label" for="enable_encrypted_analysis">
                      Encrypted Analysis
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="analyze_timing_patterns">
                    <label class="form-check-label" for="analyze_timing_patterns">
                      Timing Patterns
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="analyze_packet_sizes">
                    <label class="form-check-label" for="analyze_packet_sizes">
                      Packet Sizes
                    </label>
                  </div>
                </div>
              </div>

              <!-- ML Parameters -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">ü§ñ ML Model Parameters</h6>
                </div>
                <div class="col-md-3">
                  <label for="n_estimators" class="form-label">
                    Number of Estimators
                    <small class="text-muted">(trees in forest)</small>
                  </label>
                  <input type="number" class="form-control" id="n_estimators" min="50" max="200" step="10">
                </div>
                <div class="col-md-3">
                  <label for="max_depth" class="form-label">
                    Maximum Tree Depth
                  </label>
                  <input type="number" class="form-control" id="max_depth" min="5" max="30" step="5">
                </div>
                <div class="col-md-3">
                  <label for="model_type_select" class="form-label">
                    Model Type
                  </label>
                  <select class="form-select" id="model_type_select" aria-label="Machine learning model type selection">
                    <option value="random_forest">Random Forest</option>
                    <option value="gradient_boosting">Gradient Boosting</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="cpu_cores" class="form-label">
                    CPU Cores
                    <small class="text-muted">(-1 = all)</small>
                  </label>
                  <input type="number" class="form-control" id="cpu_cores" min="-1" max="64" step="1">
                </div>
              </div>

              <!-- LLM Configuration -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">ü§ñ LLM Enhancement (Alert Summarization & Risk Assessment)</h6>
                  <small class="text-muted">OpenAI-compatible API for incident analysis and threat intelligence summarization</small>
                </div>
                <div class="col-md-12 mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="llm_enabled">
                    <label class="form-check-label" for="llm_enabled">
                      <strong>Enable LLM Analysis</strong>
                    </label>
                  </div>
                  <small class="text-muted">Provides AI-powered alert summarization, behavior analysis, and risk prioritization</small>
                </div>
                <div class="col-md-6">
                  <label for="llm_endpoint" class="form-label">
                    <i class="bi bi-cloud"></i> API Endpoint URL
                    <small class="text-muted">(OpenAI-compatible)</small>
                  </label>
                  <input type="url" class="form-control" id="llm_endpoint" 
                         placeholder="https://api.openai.com/v1 or http://localhost:11434/v1"
                         title="OpenAI API, Ollama, or compatible endpoint">
                  <small class="text-muted">Examples: OpenAI, Ollama (http://localhost:11434/v1), or custom API</small>
                </div>
                <div class="col-md-6">
                  <label for="llm_api_key" class="form-label">
                    <i class="bi bi-key"></i> API Key
                    <small class="text-muted">(optional for local Ollama)</small>
                  </label>
                  <input type="password" class="form-control" id="llm_api_key" 
                         placeholder="sk-... (leave empty for Ollama)"
                         title="API key for OpenAI or compatible service">
                  <small class="text-muted">Required for OpenAI, optional for Ollama/local models</small>
                </div>
              </div>

              <div class="row mb-4">
                <div class="col-md-4">
                  <label for="llm_model" class="form-label">
                    <i class="bi bi-cpu"></i> Model Name
                  </label>
                  <select class="form-select" id="llm_model">
                    <optgroup label="OpenAI Models">
                      <option value="gpt-4o">GPT-4o (Recommended)</option>
                      <option value="gpt-4o-mini" selected>GPT-4o-mini (Fast & Cheap)</option>
                      <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    </optgroup>
                    <optgroup label="Local Ollama Models">
                      <option value="qwen2.5:3b">Qwen 2.5 3B (Recommended)</option>
                      <option value="qwen2.5:1.5b">Qwen 2.5 1.5B (Faster)</option>
                      <option value="llama3.2:3b">Llama 3.2 3B</option>
                      <option value="phi4:latest">Phi-4 Mini</option>
                      <option value="gemma2:2b">Gemma 2 2B</option>
                    </optgroup>
                    <optgroup label="Custom">
                      <option value="custom">Custom Model</option>
                    </optgroup>
                  </select>
                  <small class="text-muted">Choose model or select "Custom" to type manually</small>
                </div>
                <div class="col-md-4" id="llm_custom_model_container" style="display: none;">
                  <label for="llm_custom_model" class="form-label">
                    Custom Model Name
                  </label>
                  <input type="text" class="form-control" id="llm_custom_model" 
                         placeholder="model-name:tag"
                         title="Custom model identifier">
                </div>
                <div class="col-md-4">
                  <label for="llm_max_tokens" class="form-label">
                    Max Tokens (Response)
                  </label>
                  <input type="number" class="form-control" id="llm_max_tokens" 
                         min="256" max="16384" step="256" value="2048">
                  <small class="text-muted">Shorter = faster, longer = detailed</small>
                </div>
                <div class="col-md-4">
                  <label for="llm_temperature" class="form-label">
                    Temperature
                    <small class="text-muted">(creativity)</small>
                  </label>
                  <input type="range" class="form-range" id="llm_temperature" 
                         min="0" max="1" step="0.1" value="0.3">
                  <div class="text-center" id="llm_temperature_value">0.3</div>
                  <small class="text-muted">Lower = focused, higher = creative</small>
                </div>
              </div>

              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">LLM Analysis Features</h6>
                </div>
                <div class="col-md-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="llm_alert_summarization" checked>
                    <label class="form-check-label" for="llm_alert_summarization">
                      Alert Summarization
                    </label>
                  </div>
                  <small class="text-muted">Generate human-readable alert summaries</small>
                </div>
                <div class="col-md-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="llm_behavior_analysis" checked>
                    <label class="form-check-label" for="llm_behavior_analysis">
                      Behavior Analysis
                    </label>
                  </div>
                  <small class="text-muted">Analyze flow patterns and identify behaviors</small>
                </div>
                <div class="col-md-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="llm_risk_assessment" checked>
                    <label class="form-check-label" for="llm_risk_assessment">
                      Risk Assessment
                    </label>
                  </div>
                  <small class="text-muted">Prioritize incidents by severity and impact</small>
                </div>
              </div>

              <div class="row mb-4">
                <div class="col-md-6">
                  <button type="button" class="btn btn-primary w-100" id="test_llm_connection">
                    <i class="bi bi-wifi"></i> Test LLM Connection
                  </button>
                  <small class="text-muted">Verify API endpoint and model availability</small>
                </div>
                <div class="col-md-6">
                  <div id="llm_connection_status" class="alert alert-info mt-2" style="display: none;">
                    <strong>Status:</strong> <span id="llm_status_text">Not tested</span>
                  </div>
                </div>
              </div>

              <!-- Training Settings -->
              <div class="row mb-4">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">üìö Training Configuration</h6>
                </div>
                <div class="col-md-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="auto_retrain">
                    <label class="form-check-label" for="auto_retrain">
                      Auto Retrain
                    </label>
                  </div>
                  <small class="text-muted">Periodically retrain model</small>
                </div>
                <div class="col-md-3">
                  <label for="retrain_interval" class="form-label">
                    Retrain Interval (hours)
                  </label>
                  <input type="number" class="form-control" id="retrain_interval" min="1" max="168" step="1">
                </div>
                <div class="col-md-3">
                  <label for="min_training_samples" class="form-label">
                    Min Training Samples
                  </label>
                  <input type="number" class="form-control" id="min_training_samples" min="50" max="1000" step="50">
                </div>
                <div class="col-md-3">
                  <div class="form-check form-switch mt-4">
                    <input class="form-check-input" type="checkbox" id="cache_predictions">
                    <label class="form-check-label" for="cache_predictions">
                      Cache Predictions
                    </label>
                  </div>
                </div>
              </div>

              <!-- Quick Presets -->
              <div class="row">
                <div class="col-12">
                  <h6 class="text-primary border-bottom pb-2">Quick Presets</h6>
                </div>
                <div class="col-md-3">
                  <button class="btn btn-outline-primary w-100 mb-2" id="preset_aggressive">
                    <i class="bi bi-lightning"></i> More Sensitive
                  </button>
                  <small class="text-muted">Catch more ads (more false positives)</small>
                </div>
                <div class="col-md-3">
                  <button class="btn btn-outline-success w-100 mb-2" id="preset_conservative">
                    <i class="bi bi-shield-check"></i> Less Sensitive
                  </button>
                  <small class="text-muted">Fewer false positives (miss some ads)</small>
                </div>
                <div class="col-md-3">
                  <button class="btn btn-outline-info w-100 mb-2" id="preset_short_videos">
                    <i class="bi bi-clock"></i> Short Videos
                  </button>
                  <small class="text-muted">TikTok, Shorts (1min+ content)</small>
                </div>
                <div class="col-md-3">
                  <button class="btn btn-outline-warning w-100 mb-2" id="preset_quic">
                    <i class="bi bi-lock"></i> QUIC Optimized
                  </button>
                  <small class="text-muted">Encrypted traffic (timing focus)</small>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Training Dataset Management Tab -->
        <div class="tab-pane fade" id="dataset-management" role="tabpanel">
          <div class="card mt-3">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Training Dataset Management</h5>
              <button class="btn btn-sm btn-outline-secondary" onclick="refreshDatasetInfo()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-md-8">
                  <div id="dataset_info">
                    <p class="text-muted">Loading dataset information...</p>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-primary mb-2 w-100" onclick="backupDataset()">
                    <i class="bi bi-download"></i> Backup Dataset
                  </button>
                  <button class="btn btn-secondary mb-2 w-100" data-bs-toggle="modal" data-bs-target="#restoreModal">
                    <i class="bi bi-upload"></i> Restore from Backup
                  </button>
                  <button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#trimModal">
                    <i class="bi bi-scissors"></i> Trim Dataset
                  </button>
                </div>
              </div>
              <div id="backup_message" class="alert" style="display:none;"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Restore Modal -->
  <div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Restore Dataset from Backup</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="backup_select">Select Backup:</label>
            <select class="form-select" id="backup_select" aria-label="Select backup file to restore">
              <option value="">Loading backups...</option>
            </select>
          </div>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> 
            <strong>Warning:</strong> This will replace your current training dataset and restart the service.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="restoreDataset()">Restore Dataset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Trim Modal -->
  <div class="modal fade" id="trimModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Trim Training Dataset</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="trim_max_samples">Maximum Samples:</label>
            <input type="number" class="form-control" id="trim_max_samples" value="10000" min="100" step="100" aria-label="Maximum number of samples to keep">
            <small class="text-muted">Dataset will be trimmed to this many samples</small>
          </div>
          <div class="mb-3">
            <label class="form-label" for="trim_strategy">Trim Strategy:</label>
            <select class="form-select" id="trim_strategy" aria-label="Select dataset trimming strategy">
              <option value="smart">Smart (recommended - quality + diversity)</option>
              <option value="keep_balanced">Keep Balanced (equal ads/legitimate)</option>
              <option value="keep_recent">Keep Most Recent</option>
              <option value="keep_high_confidence">Keep High Confidence</option>
            </select>
            <small class="text-muted">
              Smart: Keeps high-confidence recent samples, prefers LLM-labeled, maintains domain diversity
            </small>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            A backup will be created automatically before trimming.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="trimDataset()">Trim Dataset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Model Information -->
