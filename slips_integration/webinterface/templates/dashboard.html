<div class="dashboard-container p-4">

  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-primary">
        <i class="bi bi-speedometer2"></i> System Status Dashboard
      </h2>
      <p class="text-muted">Real-time monitoring of Karen's IPS performance and security status</p>
    </div>
  </div>

  <!-- System Performance Monitoring -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-speedometer2"></i> Network Throughput
            <small class="text-muted float-end" id="dash_current_throughput">0 KB/s</small>
          </h6>
        </div>
        <div class="card-body p-2">
          <canvas id="dash_throughput_chart" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-cpu"></i> System Resources
            <small class="text-muted float-end">
              <span id="dash_current_cpu">0%</span> CPU | 
              <span id="dash_current_memory">0%</span> MEM
            </small>
          </h6>
        </div>
        <div class="card-body p-2">
          <canvas id="dash_system_chart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- System Information -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-info-circle"></i> System Information
          </h6>
        </div>
        <div class="card-body">
          <table class="table table-sm table-borderless mb-0">
            <tbody>
              <tr>
                <th width="150">IPS Version:</th>
                <td id="dash_ips_version">Loading...</td>
              </tr>
              <tr>
                <th>Uptime:</th>
                <td id="dash_uptime">Loading...</td>
              </tr>
              <tr>
                <th>Profiles:</th>
                <td id="dash_num_profiles">0</td>
              </tr>
              <tr>
                <th>Total Alerts:</th>
                <td id="dash_num_alerts">0</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-activity"></i> Recent Activity
          </h6>
        </div>
        <div class="card-body">
          <div id="dash_recent_activity">
            <p class="text-muted mb-0">Loading recent activity...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<style>
.dashboard-container .btn:focus,
.dashboard-container .btn:active {
  outline: none !important;
  box-shadow: none !important;
}

/* Force hide any modal backdrops or overlays */
.modal-backdrop {
  display: none !important;
  opacity: 0 !important;
  visibility: hidden !important;
}

.modal {
  display: none !important;
}

.modal.show {
  display: block !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
function switchToTab(tabId) {
  const tabElement = document.getElementById(tabId);
  if (tabElement) {
    const tab = new bootstrap.Tab(tabElement);
    tab.show();
    // Blur the current element to remove focus highlight
    if (document.activeElement) {
      document.activeElement.blur();
    }
  }
}

let dashThroughputChart = null;
let dashSystemChart = null;
let dashThroughputData = [];
let dashCpuData = [];
let dashMemoryData = [];
const DASH_MAX_POINTS = 60;
const DASH_REFRESH_INTERVAL = 5000;
let dashRefreshInterval = null;

function initDashboardCharts() {
  const throughputCtx = document.getElementById('dash_throughput_chart');
  const systemCtx = document.getElementById('dash_system_chart');
  
  if (!throughputCtx || !systemCtx) {
    console.log('Dashboard charts not found, retrying...');
    setTimeout(initDashboardCharts, 500);
    return;
  }

  // Destroy existing charts if they exist
  if (dashThroughputChart) {
    dashThroughputChart.destroy();
  }
  if (dashSystemChart) {
    dashSystemChart.destroy();
  }

  dashThroughputChart = new Chart(throughputCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Throughput (KB/s)',
        data: [],
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          display: false
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'KB/s'
          }
        }
      }
    }
  });

  dashSystemChart = new Chart(systemCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'CPU %',
        data: [],
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        tension: 0.4,
        yAxisID: 'y'
      }, {
        label: 'Memory %',
        data: [],
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.1)',
        tension: 0.4,
        yAxisID: 'y'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        x: {
          display: false
        },
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: '%'
          }
        }
      }
    }
  });

  console.log('Dashboard charts initialized');
}

let lastBytesTotal = 0;
let lastPerfTimestamp = 0;

function updateDashboardPerformance() {
  fetch('/api/performance?v=' + Date.now())
    .then(response => response.json())
    .then(data => {
      if (!data.success) {
        console.error('Performance API error:', data.error);
        return;
      }
      
      let throughput = 0;
      if (lastBytesTotal > 0 && lastPerfTimestamp > 0) {
        const timeDiff = (data.timestamp - lastPerfTimestamp) / 1000;
        const bytesDiff = data.throughput_kb - lastBytesTotal;
        throughput = Math.max(0, bytesDiff / timeDiff);
      }
      
      lastBytesTotal = data.throughput_kb;
      lastPerfTimestamp = data.timestamp;
      
      const cpu = data.cpu_percent || 0;
      const memory = data.memory_percent || 0;

      dashThroughputData.push(throughput);
      if (dashThroughputData.length > DASH_MAX_POINTS) {
        dashThroughputData.shift();
      }

      dashCpuData.push(cpu);
      dashMemoryData.push(memory);
      if (dashCpuData.length > DASH_MAX_POINTS) {
        dashCpuData.shift();
        dashMemoryData.shift();
      }

      if (dashThroughputChart) {
        dashThroughputChart.data.labels = Array(dashThroughputData.length).fill('');
        dashThroughputChart.data.datasets[0].data = dashThroughputData;
        dashThroughputChart.update();
        
        document.getElementById('dash_current_throughput').textContent = 
          throughput.toFixed(0) + ' KB/s (' + data.interface + ')';
      }

      if (dashSystemChart) {
        dashSystemChart.data.labels = Array(dashCpuData.length).fill('');
        dashSystemChart.data.datasets[0].data = dashCpuData;
        dashSystemChart.data.datasets[1].data = dashMemoryData;
        dashSystemChart.update();
        
        document.getElementById('dash_current_cpu').textContent = cpu.toFixed(1) + '%';
        document.getElementById('dash_current_memory').textContent = memory.toFixed(1) + '%';
      }
    })
    .catch(err => {
      console.error('Error fetching performance metrics:', err);
    });
}

function loadDashboardStats() {
  // Fetch system information from the new API endpoint
  fetch('/api/system_info?v=' + Date.now())
    .then(response => response.json())
    .then(data => {
      const versionEl = document.getElementById('dash_ips_version');
      const uptimeEl = document.getElementById('dash_uptime');
      const profilesEl = document.getElementById('dash_num_profiles');
      const alertsEl = document.getElementById('dash_num_alerts');
      
      if (versionEl) versionEl.textContent = data.version || 'Unknown';
      if (uptimeEl) uptimeEl.textContent = data.uptime || 'Unknown';
      if (profilesEl) profilesEl.textContent = data.profiles || 0;
      if (alertsEl) alertsEl.textContent = data.alerts || 0;
    })
    .catch(err => {
      console.error('Error loading system info:', err);
      // Set fallback values
      const versionEl = document.getElementById('dash_ips_version');
      const uptimeEl = document.getElementById('dash_uptime');
      if (versionEl) versionEl.textContent = 'Error loading';
      if (uptimeEl) uptimeEl.textContent = 'Error loading';
    });
  
  // Fetch recent activity
  const activityEl = document.getElementById('dash_recent_activity');
  if (activityEl) {
    activityEl.innerHTML = '<p class="text-muted mb-0 small">No recent activity</p>';
  }
}

function initDashboard() {
  console.log('Initializing dashboard...');
  initDashboardCharts();
  loadDashboardStats();
  updateDashboardPerformance();
  
  if (dashRefreshInterval) {
    clearInterval(dashRefreshInterval);
  }
  dashRefreshInterval = setInterval(() => {
    loadDashboardStats();
    updateDashboardPerformance();
  }, DASH_REFRESH_INTERVAL);
}

document.addEventListener('DOMContentLoaded', function() {
  const dashTab = document.getElementById('nav-dashboard-tab');
  if (dashTab) {
    dashTab.addEventListener('shown.bs.tab', function() {
      console.log('Dashboard tab shown');
      initDashboard();
    });
    
    if (document.getElementById('nav-dashboard').classList.contains('active')) {
      console.log('Dashboard active on load');
      setTimeout(initDashboard, 500);
    }
  }
});
</script>
